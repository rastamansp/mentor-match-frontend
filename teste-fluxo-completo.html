<!DOCTYPE html>
<html>
<head>
    <title>Teste Fluxo Completo - Gwan Events</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
            margin-bottom: 30px;
        }
        .step { 
            margin: 20px 0; 
            padding: 20px; 
            border: 2px solid #e0e0e0; 
            border-radius: 10px;
            background: #fafafa;
            transition: all 0.3s ease;
        }
        .step:hover {
            border-color: #667eea;
            background: #f5f5ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        .step h3 {
            color: #667eea;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .success { 
            background-color: #d4edda; 
            border-color: #28a745;
            border-width: 2px;
        }
        .error { 
            background-color: #f8d7da; 
            border-color: #dc3545;
            border-width: 2px;
        }
        button { 
            padding: 12px 24px; 
            margin: 5px; 
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        button:active {
            transform: translateY(0);
        }
        pre { 
            background: #f8f9fa; 
            color: #333;
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid #ddd;
        }
        pre * {
            color: #333 !important;
        }
        code {
            background: #f4f4f4;
            color: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .error pre,
        .success pre {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        .error pre *,
        .success pre * {
            color: #333 !important;
        }
        .ticket-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .qrcode-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }
        .qrcode-section img {
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }
        select, input[type="number"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            cursor: pointer;
        }
        select:hover, input[type="number"]:hover {
            border-color: #667eea;
        }
        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        option {
            padding: 8px;
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
    <h1>üé´ Teste Fluxo Completo - Gwan Events</h1>
    
    <div class="step">
        <h3>1. Autentica√ß√£o</h3>
        <button onclick="registerUser()">Registrar Usu√°rio</button>
        <button onclick="loginUser()">Fazer Login</button>
        <div id="register-result"></div>
    </div>

    <div class="step">
        <h3>1.5. Promover para Organizador</h3>
        <button onclick="promoteToOrganizer()">Promover Usu√°rio para ORGANIZER</button>
        <div id="promote-result"></div>
    </div>

    <div class="step">
        <h3>2. Buscar Eventos</h3>
        <button onclick="searchEvents()">Buscar Eventos</button>
        <div id="events-result"></div>
    </div>

    <div class="step">
        <h3>3. Detalhes do Evento</h3>
        <p><small>‚ö†Ô∏è Carregue os eventos no passo 2 e selecione abaixo</small></p>

        <div style="margin: 15px 0;">
            <label for="event-select" style="font-weight: 600; display: block; margin-bottom: 8px;">Selecione o evento:</label>
            <select id="event-select" style="padding: 10px; width: 100%; max-width: 500px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="">Carregue os eventos primeiro (passo 2)</option>
            </select>
        </div>

        <button onclick="getEventDetails()">Ver Detalhes</button>
        <div id="event-details-result"></div>
    </div>

    <div class="step">
        <h3>4. Categorias de Ingressos</h3>
        <button onclick="getTicketCategories()">Ver Categorias</button>
        <div id="categories-result"></div>
    </div>

    <div class="step">
        <h3>5. Comprar Ingresso</h3>
        <p><small>‚ö†Ô∏è Certifique-se de ter carregado as categorias de ingressos primeiro (passo 4)</small></p>
        
        <div style="margin: 15px 0;">
            <label for="category-select" style="font-weight: 600; display: block; margin-bottom: 8px;">Selecione a categoria de ingresso:</label>
            <select id="category-select" style="padding: 10px; width: 100%; max-width: 500px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="">Carregue as categorias primeiro (passo 4)</option>
            </select>
        </div>
        
        <div style="margin: 10px 0;">
            <label for="quantity-select" style="font-weight: 600; display: block; margin-bottom: 8px;">Quantidade:</label>
            <input type="number" id="quantity-input" value="1" min="1" max="10" style="padding: 10px; width: 100%; max-width: 200px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
        </div>
        
        <button onclick="processPayment()">Comprar Ingresso</button>
        <div id="payment-result"></div>
    </div>

    <div class="step">
        <h3>6. Meus Ingressos</h3>
        <button onclick="getMyTickets()">Ver Meus Ingressos</button>
        <button onclick="generateQRCode()">Gerar QR Code Individual</button>
        <div id="tickets-result"></div>
    </div>

    <div class="step">
        <h3>7. Verificar Detalhes do Ingresso</h3>
        <p><small>‚ö†Ô∏è Certifique-se de ter carregado "Meus Ingressos" primeiro (passo 6) para popular a lista</small></p>
        
        <div style="margin: 15px 0;">
            <label for="detail-ticket-select" style="font-weight: 600; display: block; margin-bottom: 8px;">Selecione o ingresso para ver detalhes:</label>
            <select id="detail-ticket-select" style="padding: 10px; width: 100%; max-width: 500px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="">Carregue 'Meus Ingressos' primeiro (passo 6)</option>
            </select>
        </div>
        
        <button onclick="checkPaymentStatus()">Verificar Detalhes</button>
        <div id="payment-status-result"></div>
    </div>

    <div class="step">
        <h3>8. Validar Ingresso</h3>
        <p><small>‚ö†Ô∏è Certifique-se de ter carregado "Meus Ingressos" primeiro (passo 6) para popular a lista</small></p>
        
        <div style="margin: 15px 0;">
            <label for="ticket-select" style="font-weight: 600; display: block; margin-bottom: 8px;">Selecione o ingresso para validar:</label>
            <select id="ticket-select" style="padding: 10px; width: 100%; max-width: 500px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="">Carregue 'Meus Ingressos' primeiro (passo 6)</option>
            </select>
        </div>
        
        <button onclick="validateTicket()">Validar Ingresso</button>
        <div id="validate-result"></div>
    </div>

    <div class="step">
        <h3>9. Check-in</h3>
        <p><small>‚ö†Ô∏è Certifique-se de ter carregado "Meus Ingressos" primeiro (passo 6) para popular a lista</small></p>
        
        <div style="margin: 15px 0;">
            <label for="checkin-ticket-select" style="font-weight: 600; display: block; margin-bottom: 8px;">Selecione o ingresso para check-in:</label>
            <select id="checkin-ticket-select" style="padding: 10px; width: 100%; max-width: 500px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="">Carregue 'Meus Ingressos' primeiro (passo 6)</option>
            </select>
        </div>
        
        <button onclick="checkIn()">Fazer Check-in</button>
        <div id="checkin-result"></div>
    </div>

    <script>
        let authToken = '';
        let currentEventId = 'ab1eb579-9fde-4a9b-b596-f0bc83649ac0'; // ID do evento existente
        let currentTicketCode = '';
        let currentPaymentId = '';
        let adminToken = '';
        let currentUserId = '';

        async function registerUser() {
            try {
                const response = await fetch('http://localhost:3001/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'joao.silva@exemplo.com',
                        password: 'senha123456',
                        name: 'Jo√£o Silva',
                        phone: '+5511999999999'
                    })
                });

                const data = await response.json();
                console.log('=== RESPOSTA DO REGISTRO ===');
                console.log('Status da resposta:', response.status);
                console.log('Status OK?', response.ok);
                console.log('Dados recebidos:', data);
                console.log('Tipo de data.access_token:', typeof data.access_token);
                console.log('Valor de data.access_token:', data.access_token);
                console.log('=== FIM DA RESPOSTA ===');
                
                if (response.ok) {
                    authToken = data.access_token;
                    currentUserId = data.user.id;
                    console.log('Token definido como:', authToken);
                    console.log('User ID capturado:', currentUserId);
                    document.getElementById('register-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Usu√°rio registrado com sucesso!</h4>
                            <p><strong>Token:</strong> ${authToken ? authToken.substring(0, 20) + '...' : 'N√£o dispon√≠vel'}</p>
                            <p><strong>User ID:</strong> ${currentUserId}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    // Se o usu√°rio j√° existe, sugere fazer login
                    if (data.message && (data.message.includes('already exists') || data.message.includes('j√° est√° cadastrado'))) {
                        document.getElementById('register-result').innerHTML = `
                            <div class="error">
                                <h4>‚ö†Ô∏è Usu√°rio j√° existe!</h4>
                                <p>Este email j√° est√° cadastrado. Clique em "Fazer Login" para continuar.</p>
                                <p><strong>Erro:</strong> ${data.message}</p>
                            </div>
                        `;
                    } else {
                        throw new Error(data.message || 'Erro no registro');
                    }
                }
            } catch (error) {
                document.getElementById('register-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro no registro:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loginUser() {
            try {
                const response = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'joao.silva@exemplo.com',
                        password: 'senha123456'
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    authToken = data.access_token;
                    currentUserId = data.user.id;
                    document.getElementById('register-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Login realizado com sucesso!</h4>
                            <p><strong>Token:</strong> ${authToken ? authToken.substring(0, 20) + '...' : 'N√£o dispon√≠vel'}</p>
                            <p><strong>User ID:</strong> ${currentUserId}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Erro no login');
                }
            } catch (error) {
                document.getElementById('register-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro no login:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function promoteToOrganizer() {
            try {
                console.log('üöÄ Iniciando processo de promo√ß√£o...');
                
                // Primeiro, fazer login como ADMIN
                console.log('1. Fazendo login como ADMIN...');
                const adminLoginResponse = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@gwanshop.com',
                        password: 'admin123'
                    })
                });

                if (!adminLoginResponse.ok) {
                    throw new Error('Erro ao fazer login como ADMIN. Execute primeiro: npm run db:seed:simple');
                }

                const adminData = await adminLoginResponse.json();
                adminToken = adminData.access_token;
                console.log('‚úÖ Login como ADMIN realizado:', adminToken ? 'SIM' : 'N√ÉO');
                console.log('üîë Token do ADMIN:', adminToken ? adminToken.substring(0, 20) + '...' : 'N√ÉO DISPON√çVEL');

                // Verificar se temos o userId do usu√°rio a ser promovido
                if (!currentUserId) {
                    throw new Error('User ID n√£o encontrado. Fa√ßa login primeiro.');
                }

                console.log('2. Promovendo usu√°rio:', currentUserId);
                console.log('üîë Usando token do ADMIN:', adminToken ? adminToken.substring(0, 20) + '...' : 'N√ÉO DISPON√çVEL');
                
                // Promover usu√°rio para ORGANIZER
                const promoteResponse = await fetch(`http://localhost:3001/api/users/${currentUserId}/promote`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        targetRole: 'ORGANIZER'
                    })
                });

                console.log('üìä Status da resposta de promo√ß√£o:', promoteResponse.status);
                console.log('üìä Status OK?', promoteResponse.ok);

                const promoteData = await promoteResponse.json();
                console.log('üìã Resposta da promo√ß√£o:', promoteData);

                if (promoteResponse.ok) {
                    document.getElementById('promote-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Usu√°rio promovido para ORGANIZER!</h4>
                            <p><strong>Usu√°rio:</strong> ${promoteData.name}</p>
                            <p><strong>Email:</strong> ${promoteData.email}</p>
                            <p><strong>Role:</strong> ${promoteData.role}</p>
                            <pre>${JSON.stringify(promoteData, null, 2)}</pre>
                        </div>
                    `;
                    
                    // Fazer login novamente como usu√°rio promovido para atualizar o token
                    console.log('3. Fazendo login novamente como usu√°rio promovido...');
                    const newLoginResponse = await fetch('http://localhost:3001/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'joao.silva@exemplo.com',
                            password: 'senha123456'
                        })
                    });

                    if (newLoginResponse.ok) {
                        const newLoginData = await newLoginResponse.json();
                        authToken = newLoginData.access_token;
                        console.log('‚úÖ Novo token obtido com role ORGANIZER');
                    }
                } else {
                    throw new Error(promoteData.message || 'Erro na promo√ß√£o');
                }
            } catch (error) {
                document.getElementById('promote-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro na promo√ß√£o:</h4>
                        <p>${error.message}</p>
                        <p><strong>Dica:</strong> Execute primeiro: npm run db:seed:simple</p>
                    </div>
                `;
            }
        }

        async function searchEvents() {
            try {
                const response = await fetch('http://localhost:3001/api/events', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                console.log('Resposta da API de eventos:', data);
                if (response.ok) {
                    // A API retorna um array diretamente, n√£o um objeto com propriedade 'events'
                    const events = Array.isArray(data) ? data : data.events || [];
                    // N√£o sobrescrever currentEventId se j√° estiver definido
                    if (!currentEventId) {
                        currentEventId = events[0]?.id || '';
                    }
                    // Preencher o select de eventos no passo 3, se existir
                    const eventSelect = document.getElementById('event-select');
                    if (eventSelect) {
                        eventSelect.innerHTML = '<option value="">Selecione um evento</option>';
                        events.forEach(ev => {
                            const option = document.createElement('option');
                            option.value = ev.id;
                            const dateText = ev.date ? new Date(ev.date).toLocaleString() : '';
                            option.textContent = `${ev.title || 'Evento'}${dateText ? ' - ' + dateText : ''}`;
                            eventSelect.appendChild(option);
                        });
                        // Selecionar o evento atual se existir; caso contr√°rio, o primeiro
                        if (currentEventId) {
                            eventSelect.value = currentEventId;
                        } else if (events[0]) {
                            eventSelect.value = events[0].id;
                            currentEventId = events[0].id;
                        }
                    }
                    console.log('Eventos encontrados:', events.length, 'Evento atual ID:', currentEventId);
                    document.getElementById('events-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Eventos encontrados! (${events.length} eventos)</h4>
                            <p><strong>Evento selecionado:</strong> ${currentEventId}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Erro na busca');
                }
            } catch (error) {
                document.getElementById('events-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro na busca:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function getEventDetails() {
            // Preferir o evento selecionado no select do passo 3
            const eventSelect = document.getElementById('event-select');
            const selectedEventId = eventSelect && eventSelect.value ? eventSelect.value : currentEventId;

            if (!selectedEventId) {
                document.getElementById('event-details-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Nenhum evento selecionado</h4>
                        <p>Carregue os eventos (passo 2) e selecione um evento acima.</p>
                    </div>
                `;
                return;
            }

            try {
                // Atualizar o currentEventId com a sele√ß√£o atual
                currentEventId = selectedEventId;
                const response = await fetch(`http://localhost:3001/api/events/${selectedEventId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('event-details-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Detalhes do evento carregados!</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Erro ao carregar detalhes');
                }
            } catch (error) {
                document.getElementById('event-details-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro ao carregar detalhes:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function getTicketCategories() {
            if (!currentEventId) {
                document.getElementById('categories-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Nenhum evento selecionado</h4>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`http://localhost:3001/api/events/${currentEventId}/ticket-categories`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (response.ok) {
                    // A API pode retornar um array diretamente ou um objeto com propriedade 'categories'
                    const categories = Array.isArray(data) ? data : data.categories || [];
                    
                    // Preencher a combobox de categorias
                    const categorySelect = document.getElementById('category-select');
                    categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                    
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        // Converter price para n√∫mero se for string
                        const price = typeof category.price === 'string' ? parseFloat(category.price) : category.price;
                        option.textContent = `${category.name} - R$ ${price.toFixed(2)}`;
                        categorySelect.appendChild(option);
                    });
                    
                    // Selecionar a primeira categoria por padr√£o (se dispon√≠vel)
                    if (categories.length > 0) {
                        categorySelect.value = categories[0].id;
                        console.log('Categoria padr√£o selecionada:', categories[0].id);
                    }
                    
                    document.getElementById('categories-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Categorias de ingressos carregadas!</h4>
                            <p><strong>Categorias dispon√≠veis:</strong> ${categories.length}</p>
                            <p><small>Selecione uma categoria no passo 5 para comprar ingresso.</small></p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Erro ao carregar categorias');
                }
            } catch (error) {
                document.getElementById('categories-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro ao carregar categorias:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function processPayment() {
            console.log('üöÄ FUN√á√ÉO processPayment() CHAMADA!');
            
            if (!currentEventId) {
                document.getElementById('payment-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Nenhum evento selecionado</h4>
                    </div>
                `;
                return;
            }

            if (!authToken) {
                document.getElementById('payment-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Token de autentica√ß√£o n√£o encontrado. Fa√ßa o registro primeiro.</h4>
                    </div>
                `;
                return;
            }

            // Ler a categoria selecionada da combobox
            const categorySelect = document.getElementById('category-select');
            const selectedCategoryId = categorySelect.value;
            
            // Ler a quantidade selecionada
            const quantityInput = document.getElementById('quantity-input');
            const quantity = parseInt(quantityInput.value) || 1;
            
            if (!selectedCategoryId) {
                document.getElementById('payment-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Selecione uma categoria de ingresso.</h4>
                        <p>Primeiro carregue as categorias (passo 4) e selecione uma na combobox acima.</p>
                    </div>
                `;
                return;
            }

            try {
                console.log('=== IN√çCIO DO PROCESSAMENTO DE PAGAMENTO ===');
                console.log('Token dispon√≠vel:', authToken ? 'SIM' : 'N√ÉO');
                console.log('Token completo:', authToken);
                console.log('Event ID:', currentEventId);
                console.log('Category ID:', selectedCategoryId);
                console.log('Quantity:', quantity);
                
                const headers = { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                };
                
                console.log('Headers sendo enviados:', headers);
                
                const response = await fetch('http://localhost:3001/api/tickets', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        eventId: currentEventId,
                        categoryId: selectedCategoryId,
                        quantity: quantity
                    })
                });

                console.log('=== RESPOSTA RECEBIDA ===');
                console.log('Status da resposta:', response.status);
                console.log('Status OK?', response.ok);
                console.log('Headers da resposta:', Object.fromEntries(response.headers.entries()));
                
                const data = await response.json();
                console.log('Dados da resposta:', data);
                console.log('=== FIM DA RESPOSTA ===');
                if (response.ok) {
                    // A resposta √© um array com um objeto dentro
                    const ticket = Array.isArray(data) ? data[0] : data;
                    currentPaymentId = ticket.id;
                    console.log('Ticket ID capturado:', currentPaymentId);
                    
                    document.getElementById('payment-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Ingresso comprado com sucesso!</h4>
                            <p><strong>Ticket ID:</strong> ${ticket.id}</p>
                            <p><strong>Evento:</strong> ${ticket.eventTitle}</p>
                            <p><strong>Categoria:</strong> ${ticket.categoryName}</p>
                            <p><strong>Pre√ßo:</strong> R$ ${ticket.price}</p>
                            <p><strong>Status:</strong> ${ticket.status}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Erro na compra do ingresso');
                }
            } catch (error) {
                document.getElementById('payment-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro no pagamento:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function checkPaymentStatus() {
            // Ler o ingresso selecionado da combobox de detalhes
            const detailTicketSelect = document.getElementById('detail-ticket-select');
            const selectedTicketId = detailTicketSelect.value;
            
            if (!selectedTicketId) {
                document.getElementById('payment-status-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Nenhum ingresso selecionado</h4>
                        <p>Por favor, selecione um ingresso na combobox acima ou carregue "Meus Ingressos" primeiro (passo 6).</p>
                    </div>
                `;
                return;
            }

            if (!authToken) {
                document.getElementById('payment-status-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Token de autentica√ß√£o n√£o encontrado</h4>
                    </div>
                `;
                return;
            }

            try {
                console.log('Verificando detalhes do ingresso:', selectedTicketId);
                const response = await fetch(`http://localhost:3001/api/tickets/${selectedTicketId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                console.log('Detalhes do ingresso:', data);
                if (response.ok) {
                    document.getElementById('payment-status-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Detalhes do ingresso carregados!</h4>
                            <p><strong>Ticket ID:</strong> ${data.id}</p>
                            <p><strong>Evento:</strong> ${data.eventTitle}</p>
                            <p><strong>Categoria:</strong> ${data.categoryName}</p>
                            <p><strong>Status:</strong> ${data.status}</p>
                            <p><strong>Pre√ßo:</strong> R$ ${data.price}</p>
                            <p><strong>Comprado em:</strong> ${data.purchaseDate || data.purchasedAt}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Erro ao verificar ingresso');
                }
            } catch (error) {
                document.getElementById('payment-status-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro ao verificar ingresso:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function getMyTickets() {
            if (!authToken) {
                document.getElementById('tickets-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Token de autentica√ß√£o n√£o encontrado. Fa√ßa o registro primeiro.</h4>
                    </div>
                `;
                return;
            }

            try {
                console.log('Buscando ingressos com token:', authToken ? authToken.substring(0, 20) + '...' : 'Token n√£o dispon√≠vel');
                const response = await fetch('http://localhost:3001/api/tickets/my-tickets', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (response.ok) {
                    // A API pode retornar um array diretamente ou um objeto com propriedade 'tickets'
                    const tickets = Array.isArray(data) ? data : data.tickets || [];
                    
                    // Preencher a combobox de ingressos para valida√ß√£o
                    const ticketSelect = document.getElementById('ticket-select');
                    const checkinTicketSelect = document.getElementById('checkin-ticket-select');
                    const detailTicketSelect = document.getElementById('detail-ticket-select');
                    
                    ticketSelect.innerHTML = '<option value="">Selecione um ingresso</option>';
                    checkinTicketSelect.innerHTML = '<option value="">Selecione um ingresso</option>';
                    detailTicketSelect.innerHTML = '<option value="">Selecione um ingresso</option>';
                    
                    tickets.forEach(ticket => {
                        const ticketCode = ticket.qrCodeData || ticket.qrCode || ticket.code || ticket.id;
                        const ticketLabel = `${ticket.eventTitle || ticket.event?.title || 'Evento'} - ${ticket.categoryName || ticket.category?.name || 'Categoria'}`;
                        
                        // Adicionar na combobox de valida√ß√£o
                        const option1 = document.createElement('option');
                        option1.value = ticketCode;
                        option1.textContent = ticketLabel;
                        ticketSelect.appendChild(option1);
                        
                        // Adicionar na combobox de check-in
                        const option2 = document.createElement('option');
                        option2.value = ticket.id; // Usar ID para check-in, n√£o o c√≥digo QR
                        option2.textContent = ticketLabel;
                        checkinTicketSelect.appendChild(option2);
                        
                        // Adicionar na combobox de detalhes
                        const option3 = document.createElement('option');
                        option3.value = ticket.id; // Usar ID para detalhes
                        option3.textContent = ticketLabel;
                        detailTicketSelect.appendChild(option3);
                    });
                    
                    // Capturar c√≥digo do ingresso da primeira propriedade dispon√≠vel
                    // O c√≥digo pode estar em qrCodeData (formato TICKET_...), qrCode, code ou id
                    const firstTicket = tickets[0];
                    if (firstTicket) {
                        currentTicketCode = firstTicket.qrCodeData || firstTicket.qrCode || firstTicket.code || firstTicket.id;
                        // Selecionar o primeiro ingresso por padr√£o
                        ticketSelect.value = currentTicketCode;
                        console.log('C√≥digo do ingresso capturado:', currentTicketCode);
                    }
                    
                    // Construir HTML com QR Code se dispon√≠vel
                    let ticketsHtml = `
                        <div class="success">
                            <h4>‚úÖ Ingressos carregados! (${tickets.length} ingresso(s))</h4>
                    `;
                    
                    tickets.forEach((ticket, index) => {
                        ticketsHtml += `
                            <div class="ticket-card" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px;">
                                <h5>Ingresso ${index + 1}</h5>
                                <p><strong>C√≥digo:</strong> ${ticket.qrCode || ticket.code || ticket.id}</p>
                                <p><strong>Evento:</strong> ${ticket.eventTitle || ticket.event?.title || 'N/A'}</p>
                                <p><strong>Categoria:</strong> ${ticket.categoryName || ticket.category?.name || 'N/A'}</p>
                                <p><strong>Status:</strong> ${ticket.status}</p>
                                <p><strong>Pre√ßo:</strong> R$ ${ticket.price || ticket.category?.price || 0}</p>
                        `;
                        
                        // Exibir QR Code se dispon√≠vel
                        const qrCodeImage = ticket.qrCode ? (ticket.qrCode.startsWith('data:image') ? ticket.qrCode : `data:image/png;base64,${ticket.qrCode}`) : null;
                        const validationUrl = ticket.qrCodeData || ticket.qrCodeUrl || 'http://localhost:3001/api/tickets/validate?code=' + (ticket.qrCode || ticket.code || ticket.id) + '&apiKey=org_12345';
                        
                        if (qrCodeImage) {
                            ticketsHtml += `
                                <div class="qrcode-section" style="margin-top: 15px;">
                                    <h6>üì± QR Code para Valida√ß√£o:</h6>
                                    <img src="${qrCodeImage}" 
                                         alt="QR Code do Ingresso" 
                                         style="max-width: 200px; border: 1px solid #ccc; border-radius: 4px;">
                                    <p><small><strong>URL de Valida√ß√£o:</strong><br>
                                    <a href="${validationUrl}" target="_blank">${validationUrl}</a></small></p>
                                    <button onclick="testValidationUrl('${validationUrl}')" 
                                            style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                        üß™ Testar URL de Valida√ß√£o
                                    </button>
                                </div>
                            `;
                        } else {
                            ticketsHtml += `
                                <div class="qrcode-section" style="margin-top: 15px;">
                                    <p><em>QR Code n√£o dispon√≠vel para este ingresso</em></p>
                                    <button onclick="generateQRCode()" 
                                            style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                        üîÑ Gerar QR Code
                                    </button>
                                </div>
                            `;
                        }
                        
                        ticketsHtml += `</div>`;
                    });
                    
                    ticketsHtml += `
                        </div>
                        <details style="margin-top: 15px;">
                            <summary>üìã Dados Completos da API</summary>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                    
                    document.getElementById('tickets-result').innerHTML = ticketsHtml;
                } else {
                    throw new Error(data.message || 'Erro ao carregar ingressos');
                }
            } catch (error) {
                document.getElementById('tickets-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro ao carregar ingressos:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Nova fun√ß√£o para gerar QR Code individual
        async function generateQRCode() {
            if (!authToken) {
                document.getElementById('tickets-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Token de autentica√ß√£o n√£o encontrado. Fa√ßa o registro primeiro.</h4>
                    </div>
                `;
                return;
            }

            try {
                console.log('üöÄ Gerando QR Code individual...');
                console.log('Token dispon√≠vel:', authToken ? 'SIM' : 'N√ÉO');
                console.log('Usando ticket ID:', currentPaymentId || 'Nenhum ingresso comprado');
                
                if (!currentPaymentId) {
                    throw new Error('Nenhum ingresso comprado ainda. Compre um ingresso primeiro.');
                }
                
                const response = await fetch(`http://localhost:3001/api/tickets/${currentPaymentId}/qrcode`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('=== RESPOSTA DO QR CODE ===');
                console.log('Status da resposta:', response.status);
                console.log('Status OK?', response.ok);
                
                const data = await response.json();
                console.log('Dados recebidos:', data);
                console.log('=== FIM DA RESPOSTA ===');

                if (response.ok) {
                    // Exibir QR Code gerado
                    let qrCodeHtml = `
                        <div class="success">
                            <h4>‚úÖ QR Code gerado com sucesso!</h4>
                            <div class="qrcode-section" style="margin-top: 15px;">
                                <h6>üì± QR Code Individual:</h6>
                                <img src="data:image/png;base64,${data.qrCode}" 
                                     alt="QR Code do Ingresso" 
                                     style="max-width: 300px; border: 2px solid #28a745; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                <p><strong>C√≥digo do Ingresso:</strong> ${data.ticketCode}</p>
                                <p><strong>ID do Ingresso:</strong> ${data.ticketId}</p>
                                <p><strong>URL de Valida√ß√£o:</strong><br>
                                <a href="${data.url}" target="_blank" style="word-break: break-all;">${data.url}</a></p>
                                <button onclick="testValidationUrl('${data.url}')" 
                                        style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                    üß™ Testar Valida√ß√£o com este QR Code
                                </button>
                            </div>
                            <details style="margin-top: 15px;">
                                <summary>üìã Dados Completos da API</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    
                    document.getElementById('tickets-result').innerHTML = qrCodeHtml;
                } else {
                    throw new Error(data.message || 'Erro ao gerar QR Code');
                }
            } catch (error) {
                document.getElementById('tickets-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro ao gerar QR Code:</h4>
                        <p>${error.message}</p>
                        <p><strong>Dica:</strong> Certifique-se de que voc√™ est√° logado e que o ingresso existe.</p>
                    </div>
                `;
            }
        }

        // Nova fun√ß√£o para testar URL de valida√ß√£o
        async function testValidationUrl(validationUrl) {
            try {
                console.log('Testando URL de valida√ß√£o:', validationUrl);
                
                // Extrair c√≥digo do ingresso da URL
                const urlParams = new URLSearchParams(validationUrl.split('?')[1]);
                const ticketCode = urlParams.get('code');
                
                if (!ticketCode) {
                    throw new Error('C√≥digo do ingresso n√£o encontrado na URL');
                }
                
                // Testar valida√ß√£o via GET
                const response = await fetch(`http://localhost:3001/api/tickets/validate?code=${ticketCode}&apiKey=org_12345`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Valida√ß√£o bem-sucedida!\n\nIngresso: ${data.ticket?.code || ticketCode}\nEvento: ${data.ticket?.eventTitle || 'N/A'}\nStatus: ${data.ticket?.status || 'N/A'}\n\nMensagem: ${data.message || 'Ingresso v√°lido'}`);
                } else {
                    alert(`‚ùå Falha na valida√ß√£o!\n\nErro: ${data.message || 'Erro desconhecido'}`);
                }
                
            } catch (error) {
                alert(`‚ùå Erro ao testar valida√ß√£o:\n\n${error.message}`);
            }
        }

        async function validateTicket() {
            // Ler o ingresso selecionado da combobox
            const ticketSelect = document.getElementById('ticket-select');
            const selectedTicketCode = ticketSelect.value;
            
            if (!selectedTicketCode) {
                document.getElementById('validate-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Nenhum ingresso selecionado</h4>
                        <p>Por favor, selecione um ingresso na combobox acima ou carregue "Meus Ingressos" primeiro (passo 6).</p>
                    </div>
                `;
                return;
            }

            try {
                console.log('Validando ingresso com c√≥digo:', selectedTicketCode);
                
                // Extrair o c√≥digo do QR Code Data se dispon√≠vel
                const codeToValidate = selectedTicketCode.includes('TICKET_') ? selectedTicketCode : selectedTicketCode;
                const apiKey = 'org_12345'; // API Key mock para testes
                
                console.log('C√≥digo a validar:', codeToValidate);
                console.log('API Key:', apiKey);
                
                const response = await fetch(`http://localhost:3001/api/tickets/validate?code=${encodeURIComponent(codeToValidate)}&apiKey=${apiKey}`, {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Resposta da valida√ß√£o:', response.status, response.ok);

                const data = await response.json();
                console.log('Dados da valida√ß√£o:', data);
                
                if (response.ok) {
                    document.getElementById('validate-result').innerHTML = `
                        <div class="${data.valid ? 'success' : 'error'}">
                            <h4>${data.valid ? '‚úÖ' : '‚ùå'} Ingresso validado!</h4>
                            <p><strong>V√°lido:</strong> ${data.valid}</p>
                            <p><strong>Mensagem:</strong> ${data.message}</p>
                            ${data.ticket ? `<p><strong>Status:</strong> ${data.ticket.status}</p>` : ''}
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Erro na valida√ß√£o');
                }
            } catch (error) {
                document.getElementById('validate-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro na valida√ß√£o:</h4>
                        <p>${error.message}</p>
                        <p><strong>Debug:</strong> C√≥digo usado = "${selectedTicketCode}"</p>
                    </div>
                `;
            }
        }

        async function checkIn() {
            // Ler o ingresso selecionado da combobox de check-in
            const checkinTicketSelect = document.getElementById('checkin-ticket-select');
            const selectedTicketId = checkinTicketSelect.value;
            
            if (!selectedTicketId) {
                document.getElementById('checkin-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Nenhum ingresso selecionado</h4>
                        <p>Por favor, selecione um ingresso na combobox acima ou carregue "Meus Ingressos" primeiro (passo 6).</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`http://localhost:3001/api/tickets/${selectedTicketId}/use`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        usedAt: new Date().toISOString()
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('checkin-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Check-in realizado com sucesso!</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Erro no check-in');
                }
            } catch (error) {
                document.getElementById('checkin-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erro no check-in:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
    </div>
</body>
</html>
